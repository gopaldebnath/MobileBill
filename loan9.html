<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Comprehensive Loan Dashboard</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { 
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: #f5f7fa;
    margin: 20px;
  }
  
  .dashboard-header {
    background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
    color: white;
    padding: 20px 0;
    margin-bottom: 20px;
    border-radius: 0 0 10px 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }
  
  .analytics-section {
    margin-bottom: 30px;
  }
  
  .section-title {
    color: #2c3e50;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 2px solid #eee;
    display: flex;
    align-items: center;
  }
  
  .section-title i {
    margin-right: 10px;
    font-size: 1.2em;
  }
  
  .chart-container {
    background: white;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    margin-bottom: 20px;
    height: 100%;
  }
  
  .summary-cards {
    display: flex;
    gap: 20px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }
  
  .summary-card {
    flex: 1;
    min-width: 300px;
    background: white;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    position: relative;
    overflow: hidden;
    border: none;
  }
  
  .summary-card::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(52, 152, 219, 0.08) 0%, rgba(155, 89, 182, 0.08) 100%);
    z-index: 0;
  }
  
  .summary-card .graph-bg {
    position: absolute;
    bottom: 0;
    right: 0;
    width: 120px;
    height: 80px;
    opacity: 0.3;
    z-index: 0;
  }
  
  .summary-card-content {
    position: relative;
    z-index: 1;
  }
  
  .summary-card h5 {
    color: #2c3e50;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 1px solid rgba(0,0,0,0.1);
    display: flex;
    align-items: center;
  }
  
  .summary-card h5 i {
    margin-right: 10px;
    font-size: 1.2em;
  }
  
  .summary-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
  }
  
  .summary-item {
    background: rgba(255,255,255,0.7);
    padding: 12px;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
  }
  
  .summary-item .label {
    font-size: 0.85em;
    color: #7f8c8d;
    margin-bottom: 5px;
    font-weight: 500;
  }
  
  .summary-item .value {
    font-weight: 700;
    font-size: 1.1em;
    color: #2c3e50;
  }
  
  .summary-item .amount {
    font-size: 0.9em;
    color: #7f8c8d;
    margin-top: 3px;
  }
  
  .data-table {
    font-size: 14px;
    width: 100%;
    border-collapse: collapse;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
  }
  
  .data-table th, 
  .data-table td {
    border: 1px solid #e0e0e0;
    padding: 10px 12px;
    text-align: center;
  }
  
  .data-table th {
    background-color: #f8f9fa;
    font-weight: 600;
    position: relative;
    color: #34495e;
  }
  
  .group-header {
    background-color: #e9ecef !important;
    font-weight: 700;
    text-align: center !important;
  }
  
  .data-table tr:nth-child(even) {
    background-color: #fafafa;
  }
  
  .data-table tr:hover {
    background-color: #f1f7ff;
  }
  
  .district-row { 
    cursor: pointer; 
    font-weight: bold; 
    background-color: #e6f0ff;
  }
  
  .block-row td:first-child { 
    text-align: left; 
    padding-left: 30px !important; 
  }
  
  .summary-row {
    font-weight: 600;
    background-color: rgba(52, 152, 219, 0.1);
  }
  
  /* Progress Bar Styles */
  .progress-thin {
    height: 6px;
    background-color: #f0f0f0;
    border-radius: 3px;
    margin-bottom: 3px;
  }
  
  .progress-bar {
    background-color: #2ecc71;
    border-radius: 3px;
  }
  
  .bg-success { background-color: #2ecc71 !important; }
  .bg-warning { background-color: #f39c12 !important; }
  .bg-danger { background-color: #e74c3c !important; }
  
  .recent-submission {
    font-size: 0.75em;
    color: #27ae60;
    display: block;
    margin-top: 3px;
    font-weight: 500;
  }
  
  .shg-card { 
    border-left: 4px solid #3498db;
  }
  
  .shg-card .graph-bg {
    background: url("data:image/svg+xml,%3Csvg width='100' height='60' viewBox='0 0 100 60' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 45 C15 35 30 50 45 40 S75 25 90 35 L100 30 V60 H0 Z' fill='%233498DB'/%3E%3Cpath d='M0 45 C15 35 30 50 45 40 S75 25 90 35 L100 30' stroke='%233498DB' stroke-width='2'/%3E%3C/svg%3E") no-repeat;
    background-size: contain;
  }
  
  .individual-card { 
    border-left: 4px solid #e74c3c;
  }
  
  .individual-card .graph-bg {
    background: url("data:image/svg+xml,%3Csvg width='100' height='60' viewBox='0 0 100 60' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 30 C20 40 40 20 60 30 S80 50 100 40 L100 60 H0 Z' fill='%23E74C3C'/%3E%3Cpath d='M0 30 C20 40 40 20 60 30 S80 50 100 40' stroke='%23E74C3C' stroke-width='2'/%3E%3C/svg%3E") no-repeat;
    background-size: contain;
  }
  
  .amount-cell {
    font-size: 0.9em;
    color: #7f8c8d;
  }
  
  .analytics-row {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    margin-bottom: 20px;
  }
  
  .analytics-col {
    flex: 1;
    min-width: 300px;
  }
  
  .card-highlight {
    background: linear-gradient(135deg, rgba(46, 204, 113, 0.1) 0%, rgba(52, 152, 219, 0.1) 100%);
    border-left: 4px solid #2ecc71;
  }
  
  .card-highlight .highlight-value {
    font-size: 1.8em;
    font-weight: 700;
    color: #2c3e50;
    margin: 10px 0;
  }
  
  .card-highlight .highlight-label {
    font-size: 0.9em;
    color: #7f8c8d;
  }
</style>
</head>
<body>

<div class="dashboard-header">
  <div class="container">
    <h1><i class="bi bi-graph-up"></i> Comprehensive Loan Dashboard</h1>
    <p class="mb-0">SHG & Individual Loan Analytics - August 2025</p>
  </div>
</div>

<div class="container">
  <!-- Summary Cards -->
  <div class="summary-cards">
    <div class="summary-card shg-card">
      <div class="graph-bg"></div>
      <div class="summary-card-content">
        <h5><i class="bi bi-people-fill"></i> SHG Loan Summary</h5>
        <div class="summary-grid" id="shg-summary">
          <!-- Will be populated by JavaScript -->
        </div>
      </div>
    </div>
    
    <div class="summary-card individual-card">
      <div class="graph-bg"></div>
      <div class="summary-card-content">
        <h5><i class="bi bi-person-fill"></i> Individual Loan Summary</h5>
        <div class="summary-grid" id="individual-summary">
          <!-- Will be populated by JavaScript -->
        </div>
      </div>
    </div>
  </div>

  <!-- Performance Highlights -->
  <div class="analytics-section">
    <h3 class="section-title"><i class="bi bi-star-fill"></i> Performance Highlights</h3>
    <div class="analytics-row">
      <div class="analytics-col">
        <div class="chart-container card-highlight">
          <div id="top-districts-shg">
            <div class="highlight-value" id="top-shg-district-value">—</div>
            <div class="highlight-label">Top Performing District (SHG Loans)</div>
            <div id="top-shg-district-name" style="font-weight:600;">—</div>
            <div id="top-shg-district-achievement" style="font-size:0.9em;color:#7f8c8d;">—</div>
          </div>
        </div>
      </div>
      <div class="analytics-col">
        <div class="chart-container card-highlight">
          <div id="top-districts-individual">
            <div class="highlight-value" id="top-individual-district-value">—</div>
            <div class="highlight-label">Top Performing District (Individual Loans)</div>
            <div id="top-individual-district-name" style="font-weight:600;">—</div>
            <div id="top-individual-district-achievement" style="font-size:0.9em;color:#7f8c8d;">—</div>
          </div>
        </div>
      </div>
      <div class="analytics-col">
        <div class="chart-container card-highlight">
          <div id="total-approval-rate">
            <div class="highlight-value" id="approval-rate-value">—</div>
            <div class="highlight-label">Overall Approval Rate</div>
            <div class="progress progress-thin mt-2">
              <div class="progress-bar" id="approval-rate-bar" role="progressbar" style="width: 0%"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Comparative Analysis -->
  <div class="analytics-section">
    <h3 class="section-title"><i class="bi bi-bar-chart-line"></i> Comparative Analysis</h3>
    <div class="analytics-row">
      <div class="analytics-col">
        <div class="chart-container">
          <canvas id="districtComparisonChart"></canvas>
        </div>
      </div>
      <div class="analytics-col">
        <div class="chart-container">
          <canvas id="loanTypeComparisonChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Trend Analysis -->
  <div class="analytics-section">
    <h3 class="section-title"><i class="bi bi-graph-up-arrow"></i> Trend Analysis</h3>
    <div class="analytics-row">
      <div class="analytics-col">
        <div class="chart-container">
          <canvas id="submissionTrendChart"></canvas>
        </div>
      </div>
      <div class="analytics-col">
        <div class="chart-container">
          <canvas id="sanctionTrendChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Detailed Data Table -->
  <div class="analytics-section">
    <h3 class="section-title"><i class="bi bi-table"></i> Detailed Loan Data</h3>
    <table class="data-table" id="loanTable">
      <thead>
        <tr>
          <th rowspan="2">District / Block Name</th>
          <th colspan="4" class="group-header">SHG Loan</th>
          <th colspan="4" class="group-header">Individual Loan</th>
          <th rowspan="2">SHG Achievement (%)</th>
          <th rowspan="2">Individual Achievement (%)</th>
        </tr>
        <tr>
          <!-- SHG Loan Group -->
          <th>Target</th>
          <th>Amount (₹ Lakh)</th>
          <th>Submitted</th>
          <th>Amount (₹ Lakh)</th>
          
          <!-- Individual Loan Group -->
          <th>Target</th>
          <th>Amount (₹ Lakh)</th>
          <th>Submitted</th>
          <th>Amount (₹ Lakh)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSKZv2oeWp8NIvfF8RX1gmUi710FpEPs-2BAhUaxq4Tr6HvY02XcoyMuO77cmFtre_u81u7dyg0tzJI/pub?gid=670451665&single=true&output=csv";

// District targets for both SHG and Individual loans
const targets = {
  "DHALAI": { shg: { loan: 800, amount: 2504 }, individual: { loan: 600, amount: 1800 } },
  "GOMATI": { shg: { loan: 850, amount: 2660.5 }, individual: { loan: 650, amount: 1950 } },
  "KHOWAI": { shg: { loan: 500, amount: 1565 }, individual: { loan: 400, amount: 1200 } },
  "NORTH TRIPURA": { shg: { loan: 510, amount: 1596.3 }, individual: { loan: 410, amount: 1230 } },
  "SEPAHIJALA": { shg: { loan: 600, amount: 1878 }, individual: { loan: 500, amount: 1500 } },
  "SOUTH TRIPURA": { shg: { loan: 750, amount: 2347.5 }, individual: { loan: 600, amount: 1800 } },
  "UNAKOTI": { shg: { loan: 400, amount: 1252 }, individual: { loan: 300, amount: 900 } },
  "WEST TRIPURA": { shg: { loan: 840, amount: 2629.2 }, individual: { loan: 640, amount: 1920 } }
};

// Function to get column indices for last 2 days based on current date
function getLast2DaysColumns() {
  const today = new Date();
  const currentDay = today.getDate();
  const currentMonth = today.getMonth() + 1;
  const currentYear = today.getFullYear();
  
  // Since we're working with August 2025 data
  const reportMonth = 8;
  const reportYear = 2025;
  
  // Calculate the last 2 days
  let day1, day2;
  
  if (reportYear === currentYear && reportMonth === currentMonth) {
    day1 = currentDay;
    day2 = currentDay - 1;
  } else {
    const lastDay = new Date(reportYear, reportMonth, 0).getDate();
    day1 = lastDay;
    day2 = lastDay - 1;
  }
  
  if (day2 < 1) day2 = 1;
  
  console.log(`Getting data for days ${day1} and ${day2} of ${reportMonth}/${reportYear}`);
  
  // Calculate column offsets for these days (each day has 8 columns starting from column 4)
  const day1Offset = (day1 - 1) * 8;
  const day2Offset = (day2 - 1) * 8;
  
  return {
    shgSubmitted: [4 + day1Offset, 4 + day2Offset],
    individualSubmitted: [8 + day1Offset, 8 + day2Offset]
  };
}

// Get the column indices for the last 2 days
const last2DaysCols = getLast2DaysColumns();

// Build column arrays for all days (31 days in August)
const shgSubmittedCount = [];
const shgSubmittedAmt = [];
const shgSanctionedCount = [];
const shgSanctionedAmt = [];
const individualSubmittedCount = [];
const individualSubmittedAmt = [];
const individualSanctionedCount = [];
const individualSanctionedAmt = [];

for (let day = 1; day <= 31; day++) {
  const dayOffset = (day - 1) * 8;
  // SHG Loan columns
  shgSubmittedCount.push(4 + dayOffset);
  shgSubmittedAmt.push(5 + dayOffset);
  shgSanctionedCount.push(6 + dayOffset);
  shgSanctionedAmt.push(7 + dayOffset);
  
  // Individual Loan columns
  individualSubmittedCount.push(8 + dayOffset);
  individualSubmittedAmt.push(9 + dayOffset);
  individualSanctionedCount.push(10 + dayOffset);
  individualSanctionedAmt.push(11 + dayOffset);
}

fetch(csvUrl)
  .then(res => res.text())
  .then(text => {
    const rows = parseCSV(text);
    const districtData = {};
    const blockData = {};

    // Skip header row
    rows.slice(1).forEach(row => {
      const district = (row[0] || "").trim().toUpperCase();
      const block = (row[1] || "").trim() || "—";
      if (!district) return;

      // SHG Loan data
      const shgSubmittedCountTotal = sumCols(row, shgSubmittedCount);
      const shgSubmittedAmtTotal = sumCols(row, shgSubmittedAmt);
      const shgSanctionedCountTotal = sumCols(row, shgSanctionedCount);
      const shgSanctionedAmtTotal = sumCols(row, shgSanctionedAmt);
      
      // Individual Loan data
      const individualSubmittedCountTotal = sumCols(row, individualSubmittedCount);
      const individualSubmittedAmtTotal = sumCols(row, individualSubmittedAmt);
      const individualSanctionedCountTotal = sumCols(row, individualSanctionedCount);
      const individualSanctionedAmtTotal = sumCols(row, individualSanctionedAmt);
      
      // Last 2 days data
      const shgLast2DaysCount = sumCols(row, last2DaysCols.shgSubmitted);
      const individualLast2DaysCount = sumCols(row, last2DaysCols.individualSubmitted);

      if (!districtData[district]) {
        districtData[district] = { 
          shg: {
            submittedCount: 0,
            submittedAmt: 0,
            sanctionedCount: 0,
            sanctionedAmt: 0,
            last2DaysCount: 0
          },
          individual: {
            submittedCount: 0,
            submittedAmt: 0,
            sanctionedCount: 0,
            sanctionedAmt: 0,
            last2DaysCount: 0
          }
        };
        blockData[district] = {};
      }
      
      // SHG data
      districtData[district].shg.submittedCount += shgSubmittedCountTotal;
      districtData[district].shg.submittedAmt += shgSubmittedAmtTotal;
      districtData[district].shg.sanctionedCount += shgSanctionedCountTotal;
      districtData[district].shg.sanctionedAmt += shgSanctionedAmtTotal;
      districtData[district].shg.last2DaysCount += shgLast2DaysCount;
      
      // Individual data
      districtData[district].individual.submittedCount += individualSubmittedCountTotal;
      districtData[district].individual.submittedAmt += individualSubmittedAmtTotal;
      districtData[district].individual.sanctionedCount += individualSanctionedCountTotal;
      districtData[district].individual.sanctionedAmt += individualSanctionedAmtTotal;
      districtData[district].individual.last2DaysCount += individualLast2DaysCount;

      if (!blockData[district][block]) {
        blockData[district][block] = { 
          shg: {
            submittedCount: 0,
            submittedAmt: 0,
            sanctionedCount: 0,
            sanctionedAmt: 0
          },
          individual: {
            submittedCount: 0,
            submittedAmt: 0,
            sanctionedCount: 0,
            sanctionedAmt: 0
          }
        };
      }
      
      // Block level SHG data
      blockData[district][block].shg.submittedCount += shgSubmittedCountTotal;
      blockData[district][block].shg.submittedAmt += shgSubmittedAmtTotal;
      blockData[district][block].shg.sanctionedCount += shgSanctionedCountTotal;
      blockData[district][block].shg.sanctionedAmt += shgSanctionedAmtTotal;
      
      // Block level Individual data
      blockData[district][block].individual.submittedCount += individualSubmittedCountTotal;
      blockData[district][block].individual.submittedAmt += individualSubmittedAmtTotal;
      blockData[district][block].individual.sanctionedCount += individualSanctionedCountTotal;
      blockData[district][block].individual.sanctionedAmt += individualSanctionedAmtTotal;
    });

    // Calculate totals for summary cards
    let shgTotalTarget = 0, shgTotalSubmitted = 0, shgTotalSanctioned = 0, shgTotalAmtSubmitted = 0, shgTotalAmtSanctioned = 0;
    let individualTotalTarget = 0, individualTotalSubmitted = 0, individualTotalSanctioned = 0, individualTotalAmtSubmitted = 0, individualTotalAmtSanctioned = 0;
    
    Object.keys(districtData).forEach(district => {
      shgTotalTarget += targets[district]?.shg.loan || 0;
      shgTotalSubmitted += districtData[district].shg.submittedCount;
      shgTotalSanctioned += districtData[district].shg.sanctionedCount;
      shgTotalAmtSubmitted += districtData[district].shg.submittedAmt;
      shgTotalAmtSanctioned += districtData[district].shg.sanctionedAmt;
      
      individualTotalTarget += targets[district]?.individual.loan || 0;
      individualTotalSubmitted += districtData[district].individual.submittedCount;
      individualTotalSanctioned += districtData[district].individual.sanctionedCount;
      individualTotalAmtSubmitted += districtData[district].individual.submittedAmt;
      individualTotalAmtSanctioned += districtData[district].individual.sanctionedAmt;
    });
    
    const shgAchievement = shgTotalTarget ? (shgTotalSanctioned / shgTotalTarget) * 100 : 0;
    const individualAchievement = individualTotalTarget ? (individualTotalSanctioned / individualTotalTarget) * 100 : 0;
    const totalApprovalRate = (shgTotalSubmitted + individualTotalSubmitted) ? 
      ((shgTotalSanctioned + individualTotalSanctioned) / (shgTotalSubmitted + individualTotalSubmitted)) * 100 : 0;
    
    // Update summary cards
    document.getElementById('shg-summary').innerHTML = `
      <div class="summary-item">
        <div class="label">Target</div>
        <div class="value">${formatInt(shgTotalTarget)}</div>
        <div class="amount">₹${formatAmt(shgTotalTarget * 3.13)} Lakh</div>
      </div>
      <div class="summary-item">
        <div class="label">Submitted</div>
        <div class="value">${formatInt(shgTotalSubmitted)}</div>
        <div class="amount">₹${formatAmt(shgTotalAmtSubmitted)} Lakh</div>
      </div>
      <div class="summary-item">
        <div class="label">Sanctioned</div>
        <div class="value">${formatInt(shgTotalSanctioned)}</div>
        <div class="amount">₹${formatAmt(shgTotalAmtSanctioned)} Lakh</div>
      </div>
      <div class="summary-item">
        <div class="label">Achievement</div>
        <div class="value">${shgAchievement.toFixed(1)}%</div>
        <div class="progress progress-thin mt-2">
          <div class="progress-bar ${getProgressBarClass(shgAchievement)}" role="progressbar" style="width: ${Math.min(shgAchievement, 100)}%"></div>
        </div>
      </div>
    `;
    
    document.getElementById('individual-summary').innerHTML = `
      <div class="summary-item">
        <div class="label">Target</div>
        <div class="value">${formatInt(individualTotalTarget)}</div>
        <div class="amount">₹${formatAmt(individualTotalTarget * 3)} Lakh</div>
      </div>
      <div class="summary-item">
        <div class="label">Submitted</div>
        <div class="value">${formatInt(individualTotalSubmitted)}</div>
        <div class="amount">₹${formatAmt(individualTotalAmtSubmitted)} Lakh</div>
      </div>
      <div class="summary-item">
        <div class="label">Sanctioned</div>
        <div class="value">${formatInt(individualTotalSanctioned)}</div>
        <div class="amount">₹${formatAmt(individualTotalAmtSanctioned)} Lakh</div>
      </div>
      <div class="summary-item">
        <div class="label">Achievement</div>
        <div class="value">${individualAchievement.toFixed(1)}%</div>
        <div class="progress progress-thin mt-2">
          <div class="progress-bar ${getProgressBarClass(individualAchievement)}" role="progressbar" style="width: ${Math.min(individualAchievement, 100)}%"></div>
        </div>
      </div>
    `;

    // Performance Highlights
    const districts = Object.keys(districtData);
    let topShgDistrict = { name: "", value: 0, achievement: 0 };
    let topIndividualDistrict = { name: "", value: 0, achievement: 0 };
    
    districts.forEach(district => {
      const shgAch = targets[district]?.shg.loan ? 
        (districtData[district].shg.sanctionedCount / targets[district].shg.loan) * 100 : 0;
      const individualAch = targets[district]?.individual.loan ? 
        (districtData[district].individual.sanctionedCount / targets[district].individual.loan) * 100 : 0;
      
      if (shgAch > topShgDistrict.achievement) {
        topShgDistrict = {
          name: district,
          value: districtData[district].shg.sanctionedCount,
          achievement: shgAch
        };
      }
      
      if (individualAch > topIndividualDistrict.achievement) {
        topIndividualDistrict = {
          name: district,
          value: districtData[district].individual.sanctionedCount,
          achievement: individualAch
        };
      }
    });
    
    document.getElementById('top-shg-district-value').textContent = formatInt(topShgDistrict.value);
    document.getElementById('top-shg-district-name').textContent = topShgDistrict.name;
    document.getElementById('top-shg-district-achievement').textContent = `Achievement: ${topShgDistrict.achievement.toFixed(1)}%`;
    
    document.getElementById('top-individual-district-value').textContent = formatInt(topIndividualDistrict.value);
    document.getElementById('top-individual-district-name').textContent = topIndividualDistrict.name;
    document.getElementById('top-individual-district-achievement').textContent = `Achievement: ${topIndividualDistrict.achievement.toFixed(1)}%`;
    
    document.getElementById('approval-rate-value').textContent = `${totalApprovalRate.toFixed(1)}%`;
    document.getElementById('approval-rate-bar').style.width = `${totalApprovalRate}%`;
    document.getElementById('approval-rate-bar').className = `progress-bar ${getProgressBarClass(totalApprovalRate)}`;

    // Prepare data for charts
    const districtNames = districts;
    const shgTargets = districts.map(d => targets[d]?.shg.loan || 0);
    const shgSubmitted = districts.map(d => districtData[d].shg.submittedCount);
    const shgSanctioned = districts.map(d => districtData[d].shg.sanctionedCount);
    const individualTargets = districts.map(d => targets[d]?.individual.loan || 0);
    const individualSubmitted = districts.map(d => districtData[d].individual.submittedCount);
    const individualSanctioned = districts.map(d => districtData[d].individual.sanctionedCount);
    
    // District Comparison Chart
    const districtComparisonCtx = document.getElementById('districtComparisonChart').getContext('2d');
    new Chart(districtComparisonCtx, {
      type: 'bar',
      data: {
        labels: districtNames,
        datasets: [
          {
            label: 'SHG Sanctioned',
            data: shgSanctioned,
            backgroundColor: 'rgba(52, 152, 219, 0.7)',
            borderColor: 'rgba(52, 152, 219, 1)',
            borderWidth: 1
          },
          {
            label: 'Individual Sanctioned',
            data: individualSanctioned,
            backgroundColor: 'rgba(231, 76, 60, 0.7)',
            borderColor: 'rgba(231, 76, 60, 1)',
            borderWidth: 1
          }
        ]
      },
      options: {
        responsive: true,
        plugins: {
          title: {
            display: true,
            text: 'District-wise Loan Sanction Comparison'
          },
        },
        scales: {
          x: {
            stacked: false,
          },
          y: {
            stacked: false,
            beginAtZero: true
          }
        }
      }
    });
    
    // Loan Type Comparison Chart
    const loanTypeComparisonCtx = document.getElementById('loanTypeComparisonChart').getContext('2d');
    new Chart(loanTypeComparisonCtx, {
      type: 'doughnut',
      data: {
        labels: ['SHG Submitted', 'SHG Sanctioned', 'Individual Submitted', 'Individual Sanctioned'],
        datasets: [{
          data: [shgTotalSubmitted, shgTotalSanctioned, individualTotalSubmitted, individualTotalSanctioned],
          backgroundColor: [
            'rgba(52, 152, 219, 0.7)',
            'rgba(52, 152, 219, 1)',
            'rgba(231, 76, 60, 0.7)',
            'rgba(231, 76, 60, 1)'
          ],
          borderColor: [
            'rgba(52, 152, 219, 1)',
            'rgba(52, 152, 219, 1)',
            'rgba(231, 76, 60, 1)',
            'rgba(231, 76, 60, 1)'
          ],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        plugins: {
          title: {
            display: true,
            text: 'Loan Type Distribution'
          },
        }
      }
    });
    
    // Trend Analysis Charts (simplified - would need daily data for proper trends)
    const days = Array.from({length: 31}, (_, i) => i + 1);
    const shgDailySubmitted = days.map(day => {
      const dayOffset = (day - 1) * 8;
      return sumCols(rows.slice(1), [4 + dayOffset]);
    });
    const shgDailySanctioned = days.map(day => {
      const dayOffset = (day - 1) * 8;
      return sumCols(rows.slice(1), [6 + dayOffset]);
    });
    const individualDailySubmitted = days.map(day => {
      const dayOffset = (day - 1) * 8;
      return sumCols(rows.slice(1), [8 + dayOffset]);
    });
    const individualDailySanctioned = days.map(day => {
      const dayOffset = (day - 1) * 8;
      return sumCols(rows.slice(1), [10 + dayOffset]);
    });
    
    // Submission Trend Chart
    const submissionTrendCtx = document.getElementById('submissionTrendChart').getContext('2d');
    new Chart(submissionTrendCtx, {
      type: 'line',
      data: {
        labels: days.map(d => `${d} Aug`),
        datasets: [
          {
            label: 'SHG Submitted',
            data: shgDailySubmitted,
            borderColor: 'rgba(52, 152, 219, 1)',
            backgroundColor: 'rgba(52, 152, 219, 0.1)',
            tension: 0.3,
            fill: true
          },
          {
            label: 'Individual Submitted',
            data: individualDailySubmitted,
            borderColor: 'rgba(231, 76, 60, 1)',
            backgroundColor: 'rgba(231, 76, 60, 0.1)',
            tension: 0.3,
            fill: true
          }
        ]
      },
      options: {
        responsive: true,
        plugins: {
          title: {
            display: true,
            text: 'Daily Loan Submission Trend'
          },
        },
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });
    
    // Sanction Trend Chart
    const sanctionTrendCtx = document.getElementById('sanctionTrendChart').getContext('2d');
    new Chart(sanctionTrendCtx, {
      type: 'line',
      data: {
        labels: days.map(d => `${d} Aug`),
        datasets: [
          {
            label: 'SHG Sanctioned',
            data: shgDailySanctioned,
            borderColor: 'rgba(52, 152, 219, 1)',
            backgroundColor: 'rgba(52, 152, 219, 0.1)',
            tension: 0.3,
            fill: true
          },
          {
            label: 'Individual Sanctioned',
            data: individualDailySanctioned,
            borderColor: 'rgba(231, 76, 60, 1)',
            backgroundColor: 'rgba(231, 76, 60, 0.1)',
            tension: 0.3,
            fill: true
          }
        ]
      },
      options: {
        responsive: true,
        plugins: {
          title: {
            display: true,
            text: 'Daily Loan Sanction Trend'
          },
        },
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });

    // Render table
    const tbody = document.querySelector("#loanTable tbody");
    
    // Render districts in specific order
    const districtOrder = [
      "DHALAI", "GOMATI", "KHOWAI", 
      "SOUTH TRIPURA", "NORTH TRIPURA",
      "SEPAHIJALA", "UNAKOTI", "WEST TRIPURA"
    ];
    
    districtOrder.forEach(district => {
      if (!districtData[district]) {
        console.warn(`District ${district} not found in data`);
        return;
      }
      
      const d = districtData[district];
      const shgTarget = targets[district]?.shg.loan ?? 0;
      const shgTargetAmt = targets[district]?.shg.amount ?? 0;
      const individualTarget = targets[district]?.individual.loan ?? 0;
      const individualTargetAmt = targets[district]?.individual.amount ?? 0;
      
      // Calculate achievements
      const shgAch = shgTarget ? (d.shg.sanctionedCount / shgTarget) * 100 : 0;
      const individualAch = individualTarget ? (d.individual.sanctionedCount / individualTarget) * 100 : 0;

      const tr = document.createElement("tr");
      tr.className = "district-row";
      tr.dataset.district = district;
      tr.innerHTML = `
        <td>${district}</td>
        
        <!-- SHG Loan Columns -->
        <td>${formatInt(shgTarget)}</td>
        <td class="amount-cell">₹${formatAmt(shgTargetAmt)}</td>
        <td>
          ${formatInt(d.shg.submittedCount)}
          ${d.shg.last2DaysCount > 0 ? `<span class="recent-submission">(${formatInt(d.shg.last2DaysCount)} in last 2 days)</span>` : ''}
        </td>
        <td class="amount-cell">₹${formatAmt(d.shg.submittedAmt)}</td>
        
        <!-- Individual Loan Columns -->
        <td>${formatInt(individualTarget)}</td>
        <td class="amount-cell">₹${formatAmt(individualTargetAmt)}</td>
        <td>
          ${formatInt(d.individual.submittedCount)}
          ${d.individual.last2DaysCount > 0 ? `<span class="recent-submission">(${formatInt(d.individual.last2DaysCount)} in last 2 days)</span>` : ''}
        </td>
        <td class="amount-cell">₹${formatAmt(d.individual.submittedAmt)}</td>
        
        <!-- Achievement Columns -->
        <td>
          <div class="progress progress-thin">
            <div class="progress-bar ${getProgressBarClass(shgAch)}" role="progressbar" style="width: ${Math.min(shgAch, 100)}%"></div>
          </div>
          <small>${shgAch.toFixed(1)}%</small>
        </td>
        <td>
          <div class="progress progress-thin">
            <div class="progress-bar ${getProgressBarClass(individualAch)}" role="progressbar" style="width: ${Math.min(individualAch, 100)}%"></div>
          </div>
          <small>${individualAch.toFixed(1)}%</small>
        </td>
      `;
      tbody.appendChild(tr);

      tr.addEventListener("click", () => toggleBlocks(tr, district, blockData[district]));
    });
    
    // Add summary row
    const trSummary = document.createElement("tr");
    trSummary.className = "summary-row";
    trSummary.innerHTML = `
      <td><strong>Total</strong></td>
      
      <!-- SHG Summary -->
      <td><strong>${formatInt(shgTotalTarget)}</strong></td>
      <td class="amount-cell"><strong>₹${formatAmt(shgTotalTarget * 3.13)}</strong></td>
      <td>
        <strong>${formatInt(shgTotalSubmitted)}</strong>
        ${districtData[districtOrder[0]].shg.last2DaysCount > 0 ? `<span class="recent-submission">(${formatInt(districtData[districtOrder[0]].shg.last2DaysCount * districtOrder.length)} in last 2 days)</span>` : ''}
      </td>
      <td class="amount-cell"><strong>₹${formatAmt(shgTotalAmtSubmitted)}</strong></td>
      
      <!-- Individual Summary -->
      <td><strong>${formatInt(individualTotalTarget)}</strong></td>
      <td class="amount-cell"><strong>₹${formatAmt(individualTotalTarget * 3)}</strong></td>
      <td>
        <strong>${formatInt(individualTotalSubmitted)}</strong>
        ${districtData[districtOrder[0]].individual.last2DaysCount > 0 ? `<span class="recent-submission">(${formatInt(districtData[districtOrder[0]].individual.last2DaysCount * districtOrder.length)} in last 2 days)</span>` : ''}
      </td>
      <td class="amount-cell"><strong>₹${formatAmt(individualTotalAmtSubmitted)}</strong></td>
      
      <!-- Achievement Summary -->
      <td>
        <div class="progress progress-thin">
          <div class="progress-bar ${getProgressBarClass(shgAchievement)}" role="progressbar" style="width: ${Math.min(shgAchievement, 100)}%"></div>
        </div>
        <small><strong>${shgAchievement.toFixed(1)}%</strong></small>
      </td>
      <td>
        <div class="progress progress-thin">
          <div class="progress-bar ${getProgressBarClass(individualAchievement)}" role="progressbar" style="width: ${Math.min(individualAchievement, 100)}%"></div>
        </div>
        <small><strong>${individualAchievement.toFixed(1)}%</strong></small>
      </td>
    `;
    tbody.appendChild(trSummary);
  });

// Helpers
function sumCols(row, cols) {
  return cols.reduce((sum, idx) => sum + (parseFloat(row[idx]) || 0), 0);
}

function getProgressBarClass(value) {
  if (value >= 80) return "bg-success";
  if (value >= 50) return "bg-warning";
  return "bg-danger";
}

function formatInt(n) { return (n||0).toLocaleString("en-IN"); }
function formatAmt(n) { return (n||0).toLocaleString("en-IN", { maximumFractionDigits: 1 }); }

// Expand/Collapse block rows using data attributes (no spaces-in-class issue)
function toggleBlocks(districtRow, districtName, blocksObj) {
  const existing = document.querySelectorAll(`tr.block-row[data-parent="${districtName}"]`);
  if (existing.length) {
    existing.forEach(el => el.remove());
    return;
  }

  // Insert rows in-order after the district row
  let last = districtRow;
  Object.keys(blocksObj).forEach(block => {
    const b = blocksObj[block];
    const trb = document.createElement("tr");
    trb.className = "block-row";
    trb.dataset.parent = districtName;
    trb.innerHTML = `
      <td>${block}</td>
      
      <!-- SHG Block Data -->
      <td>—</td>
      <td>—</td>
      <td>${formatInt(b.shg.submittedCount)}</td>
      <td class="amount-cell">₹${formatAmt(b.shg.submittedAmt)}</td>
      
      <!-- Individual Block Data -->
      <td>—</td>
      <td>—</td>
      <td>${formatInt(b.individual.submittedCount)}</td>
      <td class="amount-cell">₹${formatAmt(b.individual.submittedAmt)}</td>
      
      <!-- Empty Achievement Columns -->
      <td>—</td>
      <td>—</td>
    `;
    last.insertAdjacentElement("afterend", trb);
    last = trb;
  });
}

/* Simple CSV parser that handles quoted commas */
function parseCSV(text) {
  const rows = [];
  let row = [];
  let cur = "";
  let inQuotes = false;

  for (let i = 0; i < text.length; i++) {
    const c = text[i];
    if (c === '"') {
      if (inQuotes && text[i+1] === '"') { cur += '"'; i++; }
      else { inQuotes = !inQuotes; }
    } else if (c === ',' && !inQuotes) {
      row.push(cur); cur = "";
    } else if ((c === '\n' || c === '\r') && !inQuotes) {
      if (cur.length || row.length) { row.push(cur); rows.push(row); row = []; cur = ""; }
      // Handle CRLF: skip the next \n if current is \r
      if (c === '\r' && text[i+1] === '\n') i++;
    } else {
      cur += c;
    }
  }
  if (cur.length || row.length) { row.push(cur); rows.push(row); }
  return rows;
}
</script>

</body>
</html>
