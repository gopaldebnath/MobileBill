<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>SHG Loan Progress</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
<style>
  body { 
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: #f5f7fa;
    margin: 20px;
  }
  
  .dashboard-header {
    background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
    color: white;
    padding: 20px 0;
    margin-bottom: 20px;
    border-radius: 0 0 10px 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }
  
  .data-table {
    font-size: 14px;
    width: 100%;
    border-collapse: collapse;
  }
  
  .data-table th, 
  .data-table td {
    border: 1px solid #dee2e6;
    padding: 8px 12px;
    text-align: center;
  }
  
  .data-table th {
    background-color: #f8f9fa;
    font-weight: 600;
    position: relative;
  }
  
  .group-header {
    background-color: #e9ecef !important;
    font-weight: 700;
    text-align: center !important;
  }
  
  .data-table tr:nth-child(even) {
    background-color: #fafafa;
  }
  
  .data-table tr:hover {
    background-color: #f1f7ff;
  }
  
  .district-row { 
    cursor: pointer; 
    font-weight: bold; 
    background-color: #e6f0ff;
  }
  
  .block-row td:first-child { 
    text-align: left; 
    padding-left: 24px; 
  }
  
  .summary-row {
    font-weight: 600;
    background-color: rgba(52, 152, 219, 0.1);
  }
  
  /* Progress Bar Styles */
  .progress-thin {
    height: 6px;
    background-color: #f0f0f0;
    border-radius: 3px;
    margin-bottom: 3px;
  }
  
  .progress-bar {
    background-color: #2ecc71;
    border-radius: 3px;
  }
  
  .bg-success { background-color: #2ecc71 !important; }
  .bg-warning { background-color: #f39c12 !important; }
  .bg-danger { background-color: #e74c3c !important; }
  
  .recent-submission {
    font-size: 0.8em;
    color: #27ae60;
    display: block;
  }
</style>
</head>
<body>

<div class="dashboard-header">
  <div class="container">
    <h1><i class="bi bi-graph-up"></i> SHG Loan Progress Dashboard</h1>
    <p class="mb-0">District-wise SHG Loan Progress - August 2025</p>
  </div>
</div>

<div class="container">
  <table class="data-table" id="loanTable">
    <thead>
      <tr>
        <th rowspan="2">District / Block Name</th>
        <th colspan="2" class="group-header">Target</th>
        <th colspan="2" class="group-header">Submitted</th>
        <th colspan="2" class="group-header">Sanctioned</th>
        <th rowspan="2">Achievement (%)</th>
      </tr>
      <tr>
        <!-- Target Group -->
        <th>SHG Loan Target</th>
        <th>Amount Target (₹ Lakh)</th>
        
        <!-- Submitted Group -->
        <th>SHG Loan Submitted</th>
        <th>Amount Submitted (₹ Lakh)</th>
        
        <!-- Sanctioned Group -->
        <th>SHG Loan Sanctioned</th>
        <th>Amount Sanctioned (₹ Lakh)</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSKZv2oeWp8NIvfF8RX1gmUi710FpEPs-2BAhUaxq4Tr6HvY02XcoyMuO77cmFtre_u81u7dyg0tzJI/pub?gid=670451665&single=true&output=csv";

// District targets
const targets = {
  "DHALAI": { loan: 800, amount: 2504 },
  "GOMATI": { loan: 850, amount: 2660.5 },
  "KHOWAI": { loan: 500, amount: 1565 },
  "NORTH TRIPURA": { loan: 510, amount: 1596.3 },
  "SEPAHIJALA": { loan: 600, amount: 1878 },
  "SOUTH TRIPURA": { loan: 750, amount: 2347.5 },
  "UNAKOTI": { loan: 400, amount: 1252 },
  "WEST TRIPURA": { loan: 840, amount: 2629.2 }
};

// Function to get column indices for last 2 days based on current date
function getLast2DaysColumns() {
  const today = new Date();
  const currentDay = today.getDate();
  const currentMonth = today.getMonth() + 1; // Months are 0-indexed
  const currentYear = today.getFullYear();
  
  // Since we're working with August 2025 data
  const reportMonth = 8;
  const reportYear = 2025;
  
  // Calculate the last 2 days (adjusting for month boundaries if needed)
  let day1, day2;
  
  if (reportYear === currentYear && reportMonth === currentMonth) {
    // If we're in the same month as the report, use current day
    day1 = currentDay;
    day2 = currentDay - 1;
  } else {
    // Otherwise use the last day of the month
    const lastDay = new Date(reportYear, reportMonth, 0).getDate();
    day1 = lastDay;
    day2 = lastDay - 1;
  }
  
  // Ensure we don't go below day 1
  if (day2 < 1) day2 = 1;
  
  console.log(`Getting data for days ${day1} and ${day2} of ${reportMonth}/${reportYear}`);
  
  // Calculate column offsets for these days (each day has 8 columns starting from column 4)
  const day1Offset = (day1 - 1) * 8;
  const day2Offset = (day2 - 1) * 8;
  
  return [
    4 + day1Offset, // SHG Loan Submitted day1
    4 + day2Offset  // SHG Loan Submitted day2
  ];
}

// Get the column indices for the last 2 days
const last2DaysCols = getLast2DaysColumns();

// Column indexes for SHG loan count & amount (submitted & sanctioned)
// We'll dynamically build these based on the pattern (every 8 columns starting from 4)
const colSubmittedCount = [];
const colSubmittedAmt = [];
const colSanctionedCount = [];
const colSanctionedAmt = [];

// Build column arrays for all days (31 days in August)
for (let day = 1; day <= 31; day++) {
  const dayOffset = (day - 1) * 8;
  colSubmittedCount.push(4 + dayOffset);    // SHG Loan Submitted
  colSubmittedAmt.push(5 + dayOffset);     // SHG Loan Amt Submitted
  colSanctionedCount.push(6 + dayOffset);  // SHG Loan Sanctioned
  colSanctionedAmt.push(7 + dayOffset);    // SHG Loan Amt Sanctioned
}

fetch(csvUrl)
  .then(res => res.text())
  .then(text => {
    const rows = parseCSV(text);
    const districtData = {};
    const blockData = {};

    // Skip header row
    rows.slice(1).forEach(row => {
      const district = (row[0] || "").trim().toUpperCase();
      const block = (row[1] || "").trim() || "—";
      if (!district) return;

      const submittedCount = sumCols(row, colSubmittedCount);
      const submittedAmt   = sumCols(row, colSubmittedAmt);
      const sanctionedCount= sumCols(row, colSanctionedCount);
      const sanctionedAmt  = sumCols(row, colSanctionedAmt);
      
      // Calculate last 2 days submissions using the dynamically determined columns
      const last2DaysCount = sumCols(row, last2DaysCols);
      const last2DaysAmt = sumCols(row, last2DaysCols.map(col => col + 1)); // Amount columns are +1 from count columns

      if (!districtData[district]) {
        districtData[district] = { 
          submittedCount: 0, 
          submittedAmt: 0, 
          sanctionedCount: 0, 
          sanctionedAmt: 0,
          last2DaysCount: 0,
          last2DaysAmt: 0
        };
        blockData[district] = {};
      }
      districtData[district].submittedCount += submittedCount;
      districtData[district].submittedAmt += submittedAmt;
      districtData[district].sanctionedCount += sanctionedCount;
      districtData[district].sanctionedAmt += sanctionedAmt;
      districtData[district].last2DaysCount += last2DaysCount;
      districtData[district].last2DaysAmt += last2DaysAmt;

      if (!blockData[district][block]) {
        blockData[district][block] = { 
          submittedCount: 0, 
          submittedAmt: 0, 
          sanctionedCount: 0, 
          sanctionedAmt: 0 
        };
      }
      blockData[district][block].submittedCount += submittedCount;
      blockData[district][block].submittedAmt += submittedAmt;
      blockData[district][block].sanctionedCount += sanctionedCount;
      blockData[district][block].sanctionedAmt += sanctionedAmt;
    });

    // Render
    const tbody = document.querySelector("#loanTable tbody");
    let totalTargetLoan = 0, totalSubmittedCount = 0, totalSanctionedCount = 0;
    let totalTargetAmt = 0, totalSubmittedAmt = 0, totalSanctionedAmt = 0;
    let totalLast2DaysCount = 0;
    
    // Render districts in specific order
    const districtOrder = [
      "DHALAI", "GOMATI", "KHOWAI", 
      "SOUTH TRIPURA", "NORTH TRIPURA",
      "SEPAHIJALA", "UNAKOTI", "WEST TRIPURA"
    ];
    
    districtOrder.forEach(district => {
      if (!districtData[district]) {
        console.warn(`District ${district} not found in data`);
        return;
      }
      
      const d = districtData[district];
      const targetLoan = targets[district]?.loan ?? 0;
      const targetAmt  = targets[district]?.amount ?? 0;
      
      totalTargetLoan += targetLoan;
      totalSubmittedCount += d.submittedCount;
      totalSanctionedCount += d.sanctionedCount;
      totalTargetAmt += targetAmt;
      totalSubmittedAmt += d.submittedAmt;
      totalSanctionedAmt += d.sanctionedAmt;
      totalLast2DaysCount += d.last2DaysCount;

      // Calculate achievement based on Sanctioned vs Target
      const achLoan = targetLoan ? (d.sanctionedCount / targetLoan) * 100 : 0;

      const tr = document.createElement("tr");
      tr.className = "district-row";
      tr.dataset.district = district;
      tr.innerHTML = `
        <td>${district}</td>
        <td>${formatInt(targetLoan)}</td>
        <td>${formatAmt(targetAmt)}</td>
        <td>
          ${formatInt(d.submittedCount)}
          ${d.last2DaysCount > 0 ? `<span class="recent-submission">(${formatInt(d.last2DaysCount)} in last 2 days)</span>` : ''}
        </td>
        <td>${formatAmt(d.submittedAmt)}</td>
        <td>${formatInt(d.sanctionedCount)}</td>
        <td>${formatAmt(d.sanctionedAmt)}</td>
        <td>
          <div class="progress progress-thin">
            <div class="progress-bar ${getProgressBarClass(achLoan)}" role="progressbar" style="width: ${Math.min(achLoan, 100)}%"></div>
          </div>
          <small>${achLoan.toFixed(1)}%</small>
        </td>
      `;
      tbody.appendChild(tr);

      tr.addEventListener("click", () => toggleBlocks(tr, district, blockData[district]));
    });
    
    // Add summary row
    const totalAchLoan = totalTargetLoan ? (totalSanctionedCount / totalTargetLoan) * 100 : 0;
    
    const trSummary = document.createElement("tr");
    trSummary.className = "summary-row";
    trSummary.innerHTML = `
      <td><strong>Total</strong></td>
      <td><strong>${formatInt(totalTargetLoan)}</strong></td>
      <td><strong>${formatAmt(totalTargetAmt)}</strong></td>
      <td>
        <strong>${formatInt(totalSubmittedCount)}</strong>
        ${totalLast2DaysCount > 0 ? `<span class="recent-submission">(${formatInt(totalLast2DaysCount)} in last 2 days)</span>` : ''}
      </td>
      <td><strong>${formatAmt(totalSubmittedAmt)}</strong></td>
      <td><strong>${formatInt(totalSanctionedCount)}</strong></td>
      <td><strong>${formatAmt(totalSanctionedAmt)}</strong></td>
      <td>
        <div class="progress progress-thin">
          <div class="progress-bar ${getProgressBarClass(totalAchLoan)}" role="progressbar" style="width: ${Math.min(totalAchLoan, 100)}%"></div>
        </div>
        <small><strong>${totalAchLoan.toFixed(1)}%</strong></small>
      </td>
    `;
    tbody.appendChild(trSummary);
  });

// Helpers
function sumCols(row, cols) {
  return cols.reduce((sum, idx) => sum + (parseFloat(row[idx]) || 0), 0);
}

function getProgressBarClass(value) {
  if (value >= 80) return "bg-success";
  if (value >= 50) return "bg-warning";
  return "bg-danger";
}

function formatInt(n) { return (n||0).toLocaleString("en-IN"); }
function formatAmt(n) { return (n||0).toLocaleString("en-IN", { maximumFractionDigits: 1 }); }

// Expand/Collapse block rows using data attributes (no spaces-in-class issue)
function toggleBlocks(districtRow, districtName, blocksObj) {
  const existing = document.querySelectorAll(`tr.block-row[data-parent="${districtName}"]`);
  if (existing.length) {
    existing.forEach(el => el.remove());
    return;
  }

  // Insert rows in-order after the district row
  let last = districtRow;
  Object.keys(blocksObj).forEach(block => {
    const b = blocksObj[block];
    const trb = document.createElement("tr");
    trb.className = "block-row";
    trb.dataset.parent = districtName;
    trb.innerHTML = `
      <td>${block}</td>
      <td>—</td>
      <td>—</td>
      <td>${formatInt(b.submittedCount)}</td>
      <td>${formatAmt(b.submittedAmt)}</td>
      <td>${formatInt(b.sanctionedCount)}</td>
      <td>${formatAmt(b.sanctionedAmt)}</td>
      <td>—</td>
    `;
    last.insertAdjacentElement("afterend", trb);
    last = trb;
  });
}

/* Simple CSV parser that handles quoted commas */
function parseCSV(text) {
  const rows = [];
  let row = [];
  let cur = "";
  let inQuotes = false;

  for (let i = 0; i < text.length; i++) {
    const c = text[i];
    if (c === '"') {
      if (inQuotes && text[i+1] === '"') { cur += '"'; i++; }
      else { inQuotes = !inQuotes; }
    } else if (c === ',' && !inQuotes) {
      row.push(cur); cur = "";
    } else if ((c === '\n' || c === '\r') && !inQuotes) {
      if (cur.length || row.length) { row.push(cur); rows.push(row); row = []; cur = ""; }
      // Handle CRLF: skip the next \n if current is \r
      if (c === '\r' && text[i+1] === '\n') i++;
    } else {
      cur += c;
    }
  }
  if (cur.length || row.length) { row.push(cur); rows.push(row); }
  return rows;
}
</script>

</body>
</html>
