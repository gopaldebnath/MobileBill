<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>SHG Loan Progress Dashboard</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
<style>
  body { 
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: #f5f7fa;
    margin: 20px;
  }
  
  .dashboard-header {
    background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
    color: white;
    padding: 20px 0;
    margin-bottom: 20px;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
  }
  
  .logo-container {
    display: flex;
    align-items: center;
    gap: 20px;
    margin-bottom: 15px;
  }
  
  .logo-img {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid white;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
  }
  
  .header-content {
    text-align: center;
  }
  
  .summary-cards {
    display: flex;
    gap: 20px;
    margin-bottom: 30px;
    flex-wrap: wrap;
  }
  
  .summary-card {
    flex: 1;
    min-width: 300px;
    background: white;
    border-radius: 12px;
    padding: 0;
    box-shadow: 0 6px 18px rgba(0,0,0,0.08);
    position: relative;
    overflow: hidden;
    border: none;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }
  
  .summary-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 12px 24px rgba(0,0,0,0.12);
  }
  
  .card-header {
    padding: 15px 20px;
    color: white;
    position: relative;
    z-index: 1;
  }
  
  .shg-card .card-header {
    background: linear-gradient(135deg, #3498db 0%, #2c3e50 100%);
  }
  
  .individual-card .card-header {
    background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
  }
  
  .card-body {
    padding: 15px;
    position: relative;
    display: flex;
    align-items: center;
  }
  
  .progress-circle-container {
    flex: 0 0 100px;
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-right: 20px;
  }
  
  .progress-circle {
    width: 80px;
    height: 80px;
    position: relative;
  }
  
  .progress-circle svg {
    width: 100%;
    height: 100%;
  }
  
  .progress-circle circle {
    fill: none;
    stroke-width: 8;
    stroke-linecap: round;
    transform: rotate(-90deg);
    transform-origin: 50% 50%;
  }
  
  .progress-circle-bg {
    stroke: #f0f0f0;
  }
  
  .shg-card .progress-circle-fill {
    stroke: #3498db;
  }
  
  .individual-card .progress-circle-fill {
    stroke: #e74c3c;
  }
  
  .progress-value {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 1.6em;
    font-weight: bold;
  }
  
  .shg-card .progress-value {
    color: #3498db;
  }
  
  .individual-card .progress-value {
    color: #e74c3c;
  }
  
  .stats-container {
    flex: 1;
  }
  
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
  }
  
  .stat-item {
    background: rgba(240, 240, 240, 0.5);
    padding: 12px;
    border-radius: 8px;
    text-align: center;
  }
  
  .stat-value {
    font-size: 1.5em;
    font-weight: 700;
    margin-bottom: 5px;
    min-height: 1.5em;
  }
  
  .shg-card .stat-value {
    color: #3498db;
  }
  
  .individual-card .stat-value {
    color: #e74c3c;
  }
  
  .stat-label {
    font-size: 0.85em;
    color: #7f8c8d;
    font-weight: 500;
  }
  
  .card-pattern {
    position: absolute;
    top: 0;
    right: 0;
    width: 100px;
    height: 100px;
    opacity: 0.1;
  }
  
  .shg-card .card-pattern {
    background: radial-gradient(circle, #3498db 0%, transparent 70%);
  }
  
  .individual-card .card-pattern {
    background: radial-gradient(circle, #e74c3c 0%, transparent 70%);
  }
  
  /* Enhanced Data Table Styles */
  .data-table {
    font-size: 16px;
    width: 100%;
    border-collapse: collapse;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
  }

  .data-table th, 
  .data-table td {
    border: 1px solid #e0e0e0;
    padding: 12px 15px;
    text-align: center;
  }

  .data-table th {
    background-color: #f8f9fa;
    font-weight: 600;
    position: relative;
    color: #34495e;
    font-size: 0.95em;
  }

  .group-header {
    background-color: #e9ecef !important;
    font-weight: 700;
    text-align: center !important;
    font-size: 1em;
  }

  .data-table tr:nth-child(even) {
    background-color: #fafafa;
  }

  .data-table tr:hover {
    background-color: #f1f7ff;
  }

  .district-row { 
    cursor: pointer; 
    font-weight: bold; 
    background-color: #e6f0ff;
    font-size: 1.05em;
  }

  .block-row td:first-child { 
    text-align: left; 
    padding-left: 40px !important;
    font-size: 0.95em;
  }

  .summary-row {
    font-weight: 600;
    background-color: rgba(52, 152, 219, 0.1);
    font-size: 1.05em;
  }

  .recent-submission {
    font-size: 0.85em;
    background-color: #27ae60;
    color: white;
    padding: 2px 5px;
    border-radius: 3px;
    display: inline-block;
    margin-top: 3px;
    font-weight: 500;
  }

  .amount-cell {
    font-size: 0.95em;
    color: #7f8c8d;
  }

  .progress-thin {
    height: 6px;
    margin-bottom: 5px;
  }

  .progress-thin .progress-bar {
    border-radius: 3px;
  }

  /* Updated progress container styles */
  .progress-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
  }

  .progress-container .progress {
    width: 100%;
  }

  .text-center {
    text-align: center;
  }

  .mt-1 {
    margin-top: 4px;
  }

  /* Loading animations */
  @keyframes pulse {
    0%, 100% { opacity: 0.6; }
    50% { opacity: 1; }
  }

  .loading {
    animation: pulse 1.5s infinite ease-in-out;
    background-color: #e0e0e0;
    border-radius: 4px;
    color: transparent;
    position: relative;
    overflow: hidden;
    display: inline-block;
    min-width: 60px;
  }

  .loading::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.6), transparent);
    animation: shimmer 2s infinite;
  }

  @keyframes shimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
  }

  .progress-circle.loading circle {
    stroke: #e0e0e0;
  }

  .progress-value.loading {
    width: 50px;
    height: 24px;
    background-color: #e0e0e0;
    border-radius: 4px;
  }
  
  /* Button styles */
  .time-period-buttons {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }
  
  .time-period-btn {
    flex: 1;
    min-width: 150px;
    padding: 8px 12px;
    font-weight: 500;
    border-radius: 6px;
    transition: all 0.2s;
  }
  
  .toggle-all-btn {
    background-color: #6c757d;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    font-weight: 500;
    margin-bottom: 20px;
    transition: all 0.2s;
  }
  
  .toggle-all-btn:hover {
    background-color: #5a6268;
  }
</style>
</head>
<body>

<div class="dashboard-header">
  <div class="container">
    <div class="logo-container">
      <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/a8/Tripura_Emblem.png/330px-Tripura_Emblem.png" class="logo-img" alt="Tripura Government Logo">
      <div class="header-content">
        <h1><i class="bi bi-graph-up"></i> "SAMRIDDHI" CAMPAIGN - DASHBOARD</h1>
        <p class="mb-0">(Mahilader Arthik Khomotayoner Jonyo Ek Ononyo Podokhyep)</br>
        (1st August to 31st August, 2025)</p>
      </div>
      <img src="https://pbs.twimg.com/profile_images/1524416655140753408/yXqxucvR_400x400.jpg" class="logo-img" alt="SHG Logo">
    </div>
  </div>
</div>

<div class="container">
  <div class="summary-cards">
    <div class="summary-card shg-card">
      <div class="card-header">
        <h4><i class="bi bi-people-fill"></i> SHG Loan Summary</h4>
        <div class="card-pattern"></div>
      </div>
      <div class="card-body">
        <div class="progress-circle-container">
          <div class="progress-circle loading">
            <svg viewBox="0 0 36 36">
              <circle class="progress-circle-bg" cx="18" cy="18" r="14" stroke-dasharray="87.96" stroke-dashoffset="0"></circle>
              <circle class="progress-circle-fill" cx="18" cy="18" r="14" stroke-dasharray="87.96" stroke-dashoffset="0" id="shg-progress-circle"></circle>
            </svg>
            <div class="progress-value loading" id="shg-achievement-value"></div>
          </div>
        </div>
        
        <div class="stats-container">
          <div class="stats-grid">
            <div class="stat-item">
              <div class="stat-value loading" id="shg-target-value"></div>
              <div class="stat-label">Target</div>
            </div>
            <div class="stat-item">
              <div class="stat-value loading" id="shg-submitted-value"></div>
              <div class="stat-label">Submitted</div>
            </div>
            <div class="stat-item">
              <div class="stat-value loading" id="shg-sanctioned-value"></div>
              <div class="stat-label">Sanctioned</div>
            </div>
            <div class="stat-item">
              <div class="stat-value loading" id="shg-approval-value"></div>
              <div class="stat-label">Approval Rate</div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="summary-card individual-card">
      <div class="card-header">
        <h4><i class="bi bi-person-fill"></i> Individual Loan Summary</h4>
        <div class="card-pattern"></div>
      </div>
      <div class="card-body">
        <div class="progress-circle-container">
          <div class="progress-circle loading">
            <svg viewBox="0 0 36 36">
              <circle class="progress-circle-bg" cx="18" cy="18" r="14" stroke-dasharray="87.96" stroke-dashoffset="0"></circle>
              <circle class="progress-circle-fill" cx="18" cy="18" r="14" stroke-dasharray="87.96" stroke-dashoffset="0" id="individual-progress-circle"></circle>
            </svg>
            <div class="progress-value loading" id="individual-achievement-value"></div>
          </div>
        </div>
        
        <div class="stats-container">
          <div class="stats-grid">
            <div class="stat-item">
              <div class="stat-value loading" id="individual-target-value"></div>
              <div class="stat-label">Target</div>
            </div>
            <div class="stat-item">
              <div class="stat-value loading" id="individual-submitted-value"></div>
              <div class="stat-label">Submitted</div>
            </div>
            <div class="stat-item">
              <div class="stat-value loading" id="individual-sanctioned-value"></div>
              <div class="stat-label">Sanctioned</div>
            </div>
            <div class="stat-item">
              <div class="stat-value loading" id="individual-approval-value"></div>
              <div class="stat-label">Approval Rate</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <button id="toggleAllBtn" class="toggle-all-btn">
    <i class="bi bi-arrows-expand"></i> Expand/Collapse All Districts
  </button>
  
  <div class="time-period-buttons">
    <button class="btn btn-primary time-period-btn" data-days="5">
      <i class="bi bi-calendar-week"></i> Progress in Last 5 Days
    </button>
    <button class="btn btn-primary time-period-btn" data-days="7">
      <i class="bi bi-calendar-week"></i> Progress in Last 7 Days
    </button>
    <button class="btn btn-primary time-period-btn" data-days="10">
      <i class="bi bi-calendar-week"></i> Progress in Last 10 Days
    </button>
    <button class="btn btn-primary time-period-btn" data-days="15">
      <i class="bi bi-calendar-week"></i> Progress in Last 15 Days
    </button>
  </div>

  <table class="data-table" id="loanTable">
    <thead>
      <tr>
        <th rowspan="2">District / Block Name</th>
        <th colspan="7" class="group-header">SHG Loan</th>
        <th colspan="7" class="group-header">Individual Loan</th>
      </tr>
      <tr>
        <th>Target</th>
        <th>Target Amount (₹ Lakh)</th>
        <th>Submitted</th>
        <th>Submitted Amount (₹ Lakh)</th>
        <th>Sanctioned</th>
        <th>Sanctioned Amount (₹ Lakh)</th>
        <th>Achievement (%)</th>
        
        <th>Target</th>
        <th>Target Amount (₹ Lakh)</th>
        <th>Submitted</th>
        <th>Submitted Amount (₹ Lakh)</th>
        <th>Sanctioned</th>
        <th>Sanctioned Amount (₹ Lakh)</th>
        <th>Achievement (%)</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSKZv2oeWp8NIvfF8RX1gmUi710FpEPs-2BAhUaxq4Tr6HvY02XcoyMuO77cmFtre_u81u7dyg0tzJI/pub?gid=670451665&single=true&output=csv";

// District targets for both SHG and Individual loans
const targets = {
  "DHALAI": { 
    shg: { loan: 800, amount: 2504 }, 
    individual: { loan: 135, amount: 270 } 
  },
  "GOMATI": { 
    shg: { loan: 850, amount: 2660.5 }, 
    individual: { loan: 135, amount: 270 } 
  },
  "KHOWAI": { 
    shg: { loan: 500, amount: 1565 }, 
    individual: { loan: 85, amount: 170 } 
  },
  "NORTH TRIPURA": { 
    shg: { loan: 510, amount: 1596.3 }, 
    individual: { loan: 100, amount: 200 } 
  },
  "SEPAHIJALA": { 
    shg: { loan: 600, amount: 1878 }, 
    individual: { loan: 85, amount: 170 } 
  },
  "SOUTH TRIPURA": { 
    shg: { loan: 750, amount: 2347.5 }, 
    individual: { loan: 135, amount: 270 } 
  },
  "UNAKOTI": { 
    shg: { loan: 400, amount: 1252 }, 
    individual: { loan: 70, amount: 140 } 
  },
  "WEST TRIPURA": { 
    shg: { loan: 840, amount: 2629.2 }, 
    individual: { loan: 135, amount: 270 } 
  }
};

let allData = {}; // Store all data for time period filtering
let currentViewDays = 2; // Default to showing last 2 days

function getLastNDaysColumns(days = 2) {
  const today = new Date();
  const currentDay = today.getDate();
  const currentMonth = today.getMonth() + 1;
  const currentYear = today.getFullYear();
  
  const reportMonth = 8;
  const reportYear = 2025;
  
  let dayOffsets = [];
  
  if (reportYear === currentYear && reportMonth === currentMonth) {
    // Campaign is ongoing - get data up to current day
    const startDay = Math.max(1, currentDay - days + 1);
    for (let day = startDay; day <= currentDay; day++) {
      dayOffsets.push((day - 1) * 8);
    }
  } else if (reportYear < currentYear || (reportYear === currentYear && reportMonth < currentMonth)) {
    // Campaign is in past - get all days
    const lastDay = new Date(reportYear, reportMonth, 0).getDate();
    const startDay = Math.max(1, lastDay - days + 1);
    for (let day = startDay; day <= lastDay; day++) {
      dayOffsets.push((day - 1) * 8);
    }
  } else {
    // Campaign is in future - shouldn't happen
    console.warn("Campaign appears to be in the future");
    dayOffsets.push(0); // Just get first day
  }
  
  console.log(`Getting data for days: ${dayOffsets.map(d => (d/8)+1).join(', ')} of ${reportMonth}/${reportYear}`);
  
  return {
    shgSubmitted: dayOffsets.map(offset => 4 + offset),
    shgSubmittedAmt: dayOffsets.map(offset => 5 + offset),
    shgSanctioned: dayOffsets.map(offset => 6 + offset),
    shgSanctionedAmt: dayOffsets.map(offset => 7 + offset),
    individualSubmitted: dayOffsets.map(offset => 8 + offset),
    individualSubmittedAmt: dayOffsets.map(offset => 9 + offset),
    individualSanctioned: dayOffsets.map(offset => 10 + offset),
    individualSanctionedAmt: dayOffsets.map(offset => 11 + offset)
  };
}

function updateTableForTimePeriod(days) {
  currentViewDays = days;
  const timePeriodCols = getLastNDaysColumns(days);
  
  // Update district rows
  document.querySelectorAll("#loanTable tbody tr.district-row").forEach(row => {
    const district = row.dataset.district;
    if (!allData[district]) return;
    
    const d = allData[district];
    
    // Calculate SHG values for this time period
    const shgSubmittedCount = sumCols(d.row, timePeriodCols.shgSubmitted);
    const shgSubmittedAmt = sumCols(d.row, timePeriodCols.shgSubmittedAmt);
    const shgSanctionedCount = sumCols(d.row, timePeriodCols.shgSanctioned);
    const shgSanctionedAmt = sumCols(d.row, timePeriodCols.shgSanctionedAmt);
    
    // Calculate Individual values for this time period
    const individualSubmittedCount = sumCols(d.row, timePeriodCols.individualSubmitted);
    const individualSubmittedAmt = sumCols(d.row, timePeriodCols.individualSubmittedAmt);
    const individualSanctionedCount = sumCols(d.row, timePeriodCols.individualSanctioned);
    const individualSanctionedAmt = sumCols(d.row, timePeriodCols.individualSanctionedAmt);
    
    // Update SHG cells
    const shgTarget = targets[district]?.shg.loan ?? 0;
    const shgAch = shgTarget ? (shgSanctionedCount / shgTarget) * 100 : 0;
    
    row.cells[2].innerHTML = `
      ${formatInt(shgSubmittedCount)}
      ${shgSubmittedCount > 0 ? `<span class="recent-submission">(${formatInt(shgSubmittedCount)} in last ${days} days)</span>` : ''}
    `;
    row.cells[3].textContent = `₹${formatAmt(shgSubmittedAmt)}`;
    row.cells[4].textContent = formatInt(shgSanctionedCount);
    row.cells[5].textContent = `₹${formatAmt(shgSanctionedAmt)}`;
    row.cells[6].innerHTML = `
      <div class="progress-container">
        <div class="progress progress-thin">
          <div class="progress-bar ${getProgressBarClass(shgAch)}" role="progressbar" style="width: ${Math.min(shgAch, 100)}%"></div>
        </div>
        <div class="text-center mt-1"><small>${Math.round(shgAch)}%</small></div>
      </div>
    `;
    
    // Update Individual cells
    const individualTarget = targets[district]?.individual.loan ?? 0;
    const individualAch = individualTarget ? (individualSanctionedCount / individualTarget) * 100 : 0;
    
    row.cells[9].innerHTML = `
      ${formatInt(individualSubmittedCount)}
      ${individualSubmittedCount > 0 ? `<span class="recent-submission">(${formatInt(individualSubmittedCount)} in last ${days} days)</span>` : ''}
    `;
    row.cells[10].textContent = `₹${formatAmt(individualSubmittedAmt)}`;
    row.cells[11].textContent = formatInt(individualSanctionedCount);
    row.cells[12].textContent = `₹${formatAmt(individualSanctionedAmt)}`;
    row.cells[13].innerHTML = `
      <div class="progress-container">
        <div class="progress progress-thin">
          <div class="progress-bar ${getProgressBarClass(individualAch)}" role="progressbar" style="width: ${Math.min(individualAch, 100)}%"></div>
        </div>
        <div class="text-center mt-1"><small>${Math.round(individualAch)}%</small></div>
      </div>
    `;
  });
  
  // Update block rows if they're visible
  document.querySelectorAll("#loanTable tbody tr.block-row").forEach(row => {
    const parentDistrict = row.dataset.parent;
    const block = row.cells[0].textContent.trim();
    
    if (!allData[parentDistrict]?.blocks[block]) return;
    
    const b = allData[parentDistrict].blocks[block];
    const timePeriodCols = getLastNDaysColumns(days);
    
    // Calculate SHG values for this time period
    const shgSubmittedCount = sumCols(b.row, timePeriodCols.shgSubmitted);
    const shgSubmittedAmt = sumCols(b.row, timePeriodCols.shgSubmittedAmt);
    const shgSanctionedCount = sumCols(b.row, timePeriodCols.shgSanctioned);
    const shgSanctionedAmt = sumCols(b.row, timePeriodCols.shgSanctionedAmt);
    
    // Calculate Individual values for this time period
    const individualSubmittedCount = sumCols(b.row, timePeriodCols.individualSubmitted);
    const individualSubmittedAmt = sumCols(b.row, timePeriodCols.individualSubmittedAmt);
    const individualSanctionedCount = sumCols(b.row, timePeriodCols.individualSanctioned);
    const individualSanctionedAmt = sumCols(b.row, timePeriodCols.individualSanctionedAmt);
    
    // Update SHG cells
    row.cells[2].textContent = formatInt(shgSubmittedCount);
    row.cells[3].textContent = `₹${formatAmt(shgSubmittedAmt)}`;
    row.cells[4].textContent = formatInt(shgSanctionedCount);
    row.cells[5].textContent = `₹${formatAmt(shgSanctionedAmt)}`;
    
    // Update Individual cells
    row.cells[9].textContent = formatInt(individualSubmittedCount);
    row.cells[10].textContent = `₹${formatAmt(individualSubmittedAmt)}`;
    row.cells[11].textContent = formatInt(individualSanctionedCount);
    row.cells[12].textContent = `₹${formatAmt(individualSanctionedAmt)}`;
  });
  
  // Update summary row
  const summaryRow = document.querySelector("#loanTable tbody tr.summary-row");
  if (summaryRow) {
    // Calculate totals for the current time period
    let shgTotalSubmitted = 0, shgTotalSanctioned = 0, shgTotalAmtSubmitted = 0, shgTotalAmtSanctioned = 0;
    let individualTotalSubmitted = 0, individualTotalSanctioned = 0, individualTotalAmtSubmitted = 0, individualTotalAmtSanctioned = 0;
    
    Object.keys(allData).forEach(district => {
      const d = allData[district];
      
      shgTotalSubmitted += sumCols(d.row, timePeriodCols.shgSubmitted);
      shgTotalSanctioned += sumCols(d.row, timePeriodCols.shgSanctioned);
      shgTotalAmtSubmitted += sumCols(d.row, timePeriodCols.shgSubmittedAmt);
      shgTotalAmtSanctioned += sumCols(d.row, timePeriodCols.shgSanctionedAmt);
      
      individualTotalSubmitted += sumCols(d.row, timePeriodCols.individualSubmitted);
      individualTotalSanctioned += sumCols(d.row, timePeriodCols.individualSanctioned);
      individualTotalAmtSubmitted += sumCols(d.row, timePeriodCols.individualSubmittedAmt);
      individualTotalAmtSanctioned += sumCols(d.row, timePeriodCols.individualSanctionedAmt);
    });
    
    const shgTotalTarget = Object.values(targets).reduce((sum, t) => sum + (t?.shg.loan || 0), 0);
    const individualTotalTarget = Object.values(targets).reduce((sum, t) => sum + (t?.individual.loan || 0), 0);
    
    const shgAchievement = shgTotalTarget ? (shgTotalSanctioned / shgTotalTarget) * 100 : 0;
    const individualAchievement = individualTotalTarget ? (individualTotalSanctioned / individualTotalTarget) * 100 : 0;
    
    // Update SHG cells in summary row
    summaryRow.cells[2].innerHTML = `
      <strong>${formatInt(shgTotalSubmitted)}</strong>
      ${shgTotalSubmitted > 0 ? `<span class="recent-submission">(${formatInt(shgTotalSubmitted)} in last ${days} days)</span>` : ''}
    `;
    summaryRow.cells[3].innerHTML = `<strong>₹${formatAmt(shgTotalAmtSubmitted)}</strong>`;
    summaryRow.cells[4].innerHTML = `<strong>${formatInt(shgTotalSanctioned)}</strong>`;
    summaryRow.cells[5].innerHTML = `<strong>₹${formatAmt(shgTotalAmtSanctioned)}</strong>`;
    summaryRow.cells[6].innerHTML = `
      <div class="progress-container">
        <div class="progress progress-thin">
          <div class="progress-bar ${getProgressBarClass(shgAchievement)}" role="progressbar" style="width: ${Math.min(shgAchievement, 100)}%"></div>
        </div>
        <div class="text-center mt-1"><small><strong>${Math.round(shgAchievement)}%</strong></small></div>
      </div>
    `;
    
    // Update Individual cells in summary row
    summaryRow.cells[9].innerHTML = `
      <strong>${formatInt(individualTotalSubmitted)}</strong>
      ${individualTotalSubmitted > 0 ? `<span class="recent-submission">(${formatInt(individualTotalSubmitted)} in last ${days} days)</span>` : ''}
    `;
    summaryRow.cells[10].innerHTML = `<strong>₹${formatAmt(individualTotalAmtSubmitted)}</strong>`;
    summaryRow.cells[11].innerHTML = `<strong>${formatInt(individualTotalSanctioned)}</strong>`;
    summaryRow.cells[12].innerHTML = `<strong>₹${formatAmt(individualTotalAmtSanctioned)}</strong>`;
    summaryRow.cells[13].innerHTML = `
      <div class="progress-container">
        <div class="progress progress-thin">
          <div class="progress-bar ${getProgressBarClass(individualAchievement)}" role="progressbar" style="width: ${Math.min(individualAchievement, 100)}%"></div>
        </div>
        <div class="text-center mt-1"><small><strong>${Math.round(individualAchievement)}%</strong></small></div>
      </div>
    `;
  }
}

// Function to animate numbers counting up
function animateCountUp(element, target, duration = 1500, isPercentage = false) {
  const start = 0;
  const increment = target / (duration / 16);
  let current = start;
  
  const timer = setInterval(() => {
    current += increment;
    if (current >= target) {
      clearInterval(timer);
      current = target;
    }
    
    if (isPercentage) {
      element.textContent = `${Math.round(current)}%`;
    } else {
      element.textContent = formatInt(Math.round(current));
    }
  }, 16);
}

// Function to remove loading animations
function removeLoadingAnimations() {
  document.querySelectorAll('.loading').forEach(el => {
    el.classList.remove('loading');
  });
  document.querySelectorAll('.progress-circle.loading circle').forEach(el => {
    el.style.stroke = '';
  });
}

fetch(csvUrl)
  .then(res => res.text())
  .then(text => {
    const rows = parseCSV(text);
    allData = {}; // Reset all data
    
    const districtOrder = [
      "DHALAI", "GOMATI", "KHOWAI", 
      "SOUTH TRIPURA", "NORTH TRIPURA",
      "SEPAHIJALA", "UNAKOTI", "WEST TRIPURA"
    ];

    rows.slice(1).forEach(row => {
      const district = (row[0] || "").trim().toUpperCase();
      const block = (row[1] || "").trim() || "—";
      if (!district) return;

      if (!allData[district]) {
        allData[district] = { 
          row: row,
          blocks: {},
          shg: {
            submittedCount: 0,
            submittedAmt: 0,
            sanctionedCount: 0,
            sanctionedAmt: 0,
            last2DaysCount: 0
          },
          individual: {
            submittedCount: 0,
            submittedAmt: 0,
            sanctionedCount: 0,
            sanctionedAmt: 0,
            last2DaysCount: 0
          }
        };
      }
      
      if (block !== "—" && !allData[district].blocks[block]) {
        allData[district].blocks[block] = { row: row };
      }
    });

    let shgTotalTarget = 0, shgTotalSubmitted = 0, shgTotalSanctioned = 0, shgTotalAmtSubmitted = 0, shgTotalAmtSanctioned = 0;
    let individualTotalTarget = 0, individualTotalSubmitted = 0, individualTotalSanctioned = 0, individualTotalAmtSubmitted = 0, individualTotalAmtSanctioned = 0;
    
    Object.keys(allData).forEach(district => {
      const d = allData[district];
      
      // Calculate all-time totals
      const timePeriodCols = getLastNDaysColumns(31); // Get all days in August
      
      d.shg.submittedCount = sumCols(d.row, timePeriodCols.shgSubmitted);
      d.shg.submittedAmt = sumCols(d.row, timePeriodCols.shgSubmittedAmt);
      d.shg.sanctionedCount = sumCols(d.row, timePeriodCols.shgSanctioned);
      d.shg.sanctionedAmt = sumCols(d.row, timePeriodCols.shgSanctionedAmt);
      
      d.individual.submittedCount = sumCols(d.row, timePeriodCols.individualSubmitted);
      d.individual.submittedAmt = sumCols(d.row, timePeriodCols.individualSubmittedAmt);
      d.individual.sanctionedCount = sumCols(d.row, timePeriodCols.individualSanctioned);
      d.individual.sanctionedAmt = sumCols(d.row, timePeriodCols.individualSanctionedAmt);
      
      // Calculate last 2 days for recent submission indicator
      const last2DaysCols = getLastNDaysColumns(2);
      d.shg.last2DaysCount = sumCols(d.row, last2DaysCols.shgSubmitted);
      d.individual.last2DaysCount = sumCols(d.row, last2DaysCols.individualSubmitted);
      
      shgTotalTarget += targets[district]?.shg.loan || 0;
      shgTotalSubmitted += d.shg.submittedCount;
      shgTotalSanctioned += d.shg.sanctionedCount;
      shgTotalAmtSubmitted += d.shg.submittedAmt;
      shgTotalAmtSanctioned += d.shg.sanctionedAmt;
      
      individualTotalTarget += targets[district]?.individual.loan || 0;
      individualTotalSubmitted += d.individual.submittedCount;
      individualTotalSanctioned += d.individual.sanctionedCount;
      individualTotalAmtSubmitted += d.individual.submittedAmt;
      individualTotalAmtSanctioned += d.individual.sanctionedAmt;
    });
    
    const shgAchievement = shgTotalTarget ? (shgTotalSanctioned / shgTotalTarget) * 100 : 0;
    const individualAchievement = individualTotalTarget ? (individualTotalSanctioned / individualTotalTarget) * 100 : 0;
    const shgApprovalRate = shgTotalSubmitted ? (shgTotalSanctioned / shgTotalSubmitted) * 100 : 0;
    const individualApprovalRate = individualTotalSubmitted ? (individualTotalSanctioned / individualTotalSubmitted) * 100 : 0;

    // Remove loading animations before updating content
    removeLoadingAnimations();

    // Animate the numbers counting up
    animateCountUp(document.getElementById('shg-target-value'), shgTotalTarget);
    animateCountUp(document.getElementById('shg-submitted-value'), shgTotalSubmitted);
    animateCountUp(document.getElementById('shg-sanctioned-value'), shgTotalSanctioned);
    animateCountUp(document.getElementById('shg-approval-value'), shgApprovalRate, 1500, true);
    animateCountUp(document.getElementById('shg-achievement-value'), shgAchievement, 1500, true);
    
    animateCountUp(document.getElementById('individual-target-value'), individualTotalTarget);
    animateCountUp(document.getElementById('individual-submitted-value'), individualTotalSubmitted);
    animateCountUp(document.getElementById('individual-sanctioned-value'), individualTotalSanctioned);
    animateCountUp(document.getElementById('individual-approval-value'), individualApprovalRate, 1500, true);
    animateCountUp(document.getElementById('individual-achievement-value'), individualAchievement, 1500, true);
    
    // Animate progress circles
    animateProgressCircle('shg-progress-circle', shgAchievement);
    animateProgressCircle('individual-progress-circle', individualAchievement);

    const tbody = document.querySelector("#loanTable tbody");
    tbody.innerHTML = ''; // Clear existing rows
    
    districtOrder.forEach(district => {
      if (!allData[district]) {
        console.warn(`District ${district} not found in data`);
        return;
      }
      
      const d = allData[district];
      const shgTarget = targets[district]?.shg.loan ?? 0;
      const shgTargetAmt = targets[district]?.shg.amount ?? 0;
      const individualTarget = targets[district]?.individual.loan ?? 0;
      const individualTargetAmt = targets[district]?.individual.amount ?? 0;
      
      const shgAch = shgTarget ? (d.shg.sanctionedCount / shgTarget) * 100 : 0;
      const individualAch = individualTarget ? (d.individual.sanctionedCount / individualTarget) * 100 : 0;

      const tr = document.createElement("tr");
      tr.className = "district-row";
      tr.dataset.district = district;
      tr.innerHTML = `
        <td>${district}</td>
        
        <td>${formatInt(shgTarget)}</td>
        <td class="amount-cell">₹${formatAmt(shgTargetAmt)}</td>
        <td>
          ${formatInt(d.shg.submittedCount)}
          ${d.shg.last2DaysCount > 0 ? `<span class="recent-submission">(${formatInt(d.shg.last2DaysCount)} in last 2 days)</span>` : ''}
        </td>
        <td class="amount-cell">₹${formatAmt(d.shg.submittedAmt)}</td>
        <td>${formatInt(d.shg.sanctionedCount)}</td>
        <td class="amount-cell">₹${formatAmt(d.shg.sanctionedAmt)}</td>
        <td>
          <div class="progress-container">
            <div class="progress progress-thin">
              <div class="progress-bar ${getProgressBarClass(shgAch)}" role="progressbar" style="width: ${Math.min(shgAch, 100)}%"></div>
            </div>
            <div class="text-center mt-1"><small>${Math.round(shgAch)}%</small></div>
          </div>
        </td>
        
        <td>${formatInt(individualTarget)}</td>
        <td class="amount-cell">₹${formatAmt(individualTargetAmt)}</td>
        <td>
          ${formatInt(d.individual.submittedCount)}
          ${d.individual.last2DaysCount > 0 ? `<span class="recent-submission">(${formatInt(d.individual.last2DaysCount)} in last 2 days)</span>` : ''}
        </td>
        <td class="amount-cell">₹${formatAmt(d.individual.submittedAmt)}</td>
        <td>${formatInt(d.individual.sanctionedCount)}</td>
        <td class="amount-cell">₹${formatAmt(d.individual.sanctionedAmt)}</td>
        <td>
          <div class="progress-container">
            <div class="progress progress-thin">
              <div class="progress-bar ${getProgressBarClass(individualAch)}" role="progressbar" style="width: ${Math.min(individualAch, 100)}%"></div>
            </div>
            <div class="text-center mt-1"><small>${Math.round(individualAch)}%</small></div>
          </div>
        </td>
      `;
      tbody.appendChild(tr);

      tr.addEventListener("click", () => toggleBlocks(tr, district, allData[district].blocks));
    });
    
    const trSummary = document.createElement("tr");
    trSummary.className = "summary-row";
    trSummary.innerHTML = `
      <td><strong>Total</strong></td>
      
      <td><strong>${formatInt(shgTotalTarget)}</strong></td>
      <td class="amount-cell"><strong>₹${formatAmt(shgTotalTarget * 3.13)}</strong></td>
      <td>
        <strong>${formatInt(shgTotalSubmitted)}</strong>
        ${allData[districtOrder[0]].shg.last2DaysCount > 0 ? `<span class="recent-submission">(${formatInt(allData[districtOrder[0]].shg.last2DaysCount * districtOrder.length)} in last 2 days)</span>` : ''}
      </td>
      <td class="amount-cell"><strong>₹${formatAmt(shgTotalAmtSubmitted)}</strong></td>
      <td><strong>${formatInt(shgTotalSanctioned)}</strong></td>
      <td class="amount-cell"><strong>₹${formatAmt(shgTotalAmtSanctioned)}</strong></td>
      <td>
        <div class="progress-container">
          <div class="progress progress-thin">
            <div class="progress-bar ${getProgressBarClass(shgAchievement)}" role="progressbar" style="width: ${Math.min(shgAchievement, 100)}%"></div>
          </div>
          <div class="text-center mt-1"><small><strong>${Math.round(shgAchievement)}%</strong></small></div>
        </div>
      </td>
      
      <td><strong>${formatInt(individualTotalTarget)}</strong></td>
      <td class="amount-cell"><strong>₹${formatAmt(individualTotalTarget * 2)}</strong></td>
      <td>
        <strong>${formatInt(individualTotalSubmitted)}</strong>
        ${allData[districtOrder[0]].individual.last2DaysCount > 0 ? `<span class="recent-submission">(${formatInt(allData[districtOrder[0]].individual.last2DaysCount * districtOrder.length)} in last 2 days)</span>` : ''}
      </td>
      <td class="amount-cell"><strong>₹${formatAmt(individualTotalAmtSubmitted)}</strong></td>
      <td><strong>${formatInt(individualTotalSanctioned)}</strong></td>
      <td class="amount-cell"><strong>₹${formatAmt(individualTotalAmtSanctioned)}</strong></td>
      <td>
        <div class="progress-container">
          <div class="progress progress-thin">
            <div class="progress-bar ${getProgressBarClass(individualAchievement)}" role="progressbar" style="width: ${Math.min(individualAchievement, 100)}%"></div>
          </div>
          <div class="text-center mt-1"><small><strong>${Math.round(individualAchievement)}%</strong></small></div>
        </div>
      </td>
    `;
    tbody.appendChild(trSummary);
    
    // Set up time period buttons
    document.querySelectorAll('.time-period-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const days = parseInt(btn.dataset.days);
        updateTableForTimePeriod(days);
        
        // Update active button styling
        document.querySelectorAll('.time-period-btn').forEach(b => {
          b.classList.remove('btn-primary');
          b.classList.add('btn-outline-primary');
        });
        btn.classList.remove('btn-outline-primary');
        btn.classList.add('btn-primary');
      });
    });
    
    // Set up toggle all button
    document.getElementById('toggleAllBtn').addEventListener('click', () => {
      const isExpanded = document.querySelectorAll('tr.block-row').length > 0;
      
      if (isExpanded) {
        // Collapse all
        document.querySelectorAll('tr.block-row').forEach(el => el.remove());
        document.getElementById('toggleAllBtn').innerHTML = '<i class="bi bi-arrows-expand"></i> Expand All Districts';
      } else {
        // Expand all
        document.querySelectorAll('tr.district-row').forEach(row => {
          const district = row.dataset.district;
          if (allData[district]) {
            toggleBlocks(row, district, allData[district].blocks, true);
          }
        });
        document.getElementById('toggleAllBtn').innerHTML = '<i class="bi bi-arrows-collapse"></i> Collapse All Districts';
      }
    });
  })
  .catch(error => {
    console.error("Error loading data:", error);
    removeLoadingAnimations();
    document.querySelectorAll('.stat-value').forEach(el => {
      el.textContent = "Error";
    });
  });

function animateProgressCircle(id, percentage) {
  const circle = document.getElementById(id);
  const radius = 14;
  const circumference = 2 * Math.PI * radius;
  const offset = circumference - (percentage / 100) * circumference;
  
  circle.style.strokeDasharray = circumference;
  circle.style.strokeDashoffset = circumference;
  
  setTimeout(() => {
    circle.style.strokeDashoffset = offset;
  }, 100);
}

function sumCols(row, cols) {
  return cols.reduce((sum, idx) => sum + (parseFloat(row[idx]) || 0), 0);
}

function getProgressBarClass(value) {
  if (value >= 80) return "bg-success";
  if (value >= 50) return "bg-warning";
  return "bg-danger";
}

function formatInt(n) { return (n||0).toLocaleString("en-IN"); }
function formatAmt(n) { return (n||0).toLocaleString("en-IN", { maximumFractionDigits: 1 }); }

function toggleBlocks(districtRow, districtName, blocksObj, forceExpand = false) {
  const existing = document.querySelectorAll(`tr.block-row[data-parent="${districtName}"]`);
  
  if (existing.length > 0 && !forceExpand) {
    // Collapse
    existing.forEach(el => el.remove());
    return;
  }
  
  if (existing.length > 0 && forceExpand) {
    return; // Already expanded
  }

  let last = districtRow;
  Object.keys(blocksObj).forEach(block => {
    const b = blocksObj[block];
    const timePeriodCols = getLastNDaysColumns(currentViewDays);
    
    // Calculate values for current time period
    const shgSubmittedCount = sumCols(b.row, timePeriodCols.shgSubmitted);
    const shgSubmittedAmt = sumCols(b.row, timePeriodCols.shgSubmittedAmt);
    const shgSanctionedCount = sumCols(b.row, timePeriodCols.shgSanctioned);
    const shgSanctionedAmt = sumCols(b.row, timePeriodCols.shgSanctionedAmt);
    
    const individualSubmittedCount = sumCols(b.row, timePeriodCols.individualSubmitted);
    const individualSubmittedAmt = sumCols(b.row, timePeriodCols.individualSubmittedAmt);
    const individualSanctionedCount = sumCols(b.row, timePeriodCols.individualSanctioned);
    const individualSanctionedAmt = sumCols(b.row, timePeriodCols.individualSanctionedAmt);

    const trb = document.createElement("tr");
    trb.className = "block-row";
    trb.dataset.parent = districtName;
    trb.innerHTML = `
      <td>${block}</td>
      
      <td>—</td>
      <td>—</td>
      <td>${formatInt(shgSubmittedCount)}</td>
      <td class="amount-cell">₹${formatAmt(shgSubmittedAmt)}</td>
      <td>${formatInt(shgSanctionedCount)}</td>
      <td class="amount-cell">₹${formatAmt(shgSanctionedAmt)}</td>
      <td>—</td>
      
      <td>—</td>
      <td>—</td>
      <td>${formatInt(individualSubmittedCount)}</td>
      <td class="amount-cell">₹${formatAmt(individualSubmittedAmt)}</td>
      <td>${formatInt(individualSanctionedCount)}</td>
      <td class="amount-cell">₹${formatAmt(individualSanctionedAmt)}</td>
      <td>—</td>
    `;
    last.insertAdjacentElement("afterend", trb);
    last = trb;
  });
}

function parseCSV(text) {
  const rows = [];
  let row = [];
  let cur = "";
  let inQuotes = false;

  for (let i = 0; i < text.length; i++) {
    const c = text[i];
    if (c === '"') {
      if (inQuotes && text[i+1] === '"') { cur += '"'; i++; }
      else { inQuotes = !inQuotes; }
    } else if (c === ',' && !inQuotes) {
      row.push(cur); cur = "";
    } else if ((c === '\n' || c === '\r') && !inQuotes) {
      if (cur.length || row.length) { row.push(cur); rows.push(row); row = []; cur = ""; }
      if (c === '\r' && text[i+1] === '\n') i++;
    } else {
      cur += c;
    }
  }
  if (cur.length || row.length) { row.push(cur); rows.push(row); }
  return rows;
}
</script>

</body>
</html>
